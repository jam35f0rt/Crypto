<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3498db">
  <meta name="description" content="Track cryptocurrency prices in real-time with this modern Progressive Web App">
  <title>Crypto Tracker</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/icon-512x512.svg">
  <link rel="apple-touch-icon" href="icons/icon-512x512.svg">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
  
  <!-- Simplified Service Worker Registration -->
  <script>
    // Register a minimal service worker that doesn't try to cache too many resources
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        const swContent = `
          const CACHE_NAME = 'crypto-tracker-v1';
          
          // Use only essential files for caching
          const ASSETS_TO_CACHE = [
            './',
            './index.html',
            'https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js'
          ];

          // Install event
          self.addEventListener('install', event => {
            self.skipWaiting(); // Force activation
            console.log('Service worker installed');
          });

          // Activate event
          self.addEventListener('activate', event => {
            console.log('Service worker activated');
            event.waitUntil(clients.claim()); // Take control immediately
          });

          // Fetch event - Simple passthrough
          self.addEventListener('fetch', event => {
            // Just use the network - don't try to cache yet
            event.respondWith(fetch(event.request).catch(() => {
              // If network fails for HTML requests, serve the home page
              if (event.request.headers.get('accept') && 
                  event.request.headers.get('accept').includes('text/html')) {
                return caches.match('./index.html');
              }
              
              return new Response('Network error happened', {
                status: 408,
                headers: { 'Content-Type': 'text/plain' }
              });
            }));
          });
        `;
        
        // Register an inline service worker
        try {
          const swBlob = new Blob([swContent], {type: 'application/javascript'});
          const swBlobUrl = URL.createObjectURL(swBlob);
          
          navigator.serviceWorker.register(swBlobUrl)
            .then(function(registration) {
              console.log('Service Worker registered successfully');
            })
            .catch(function(error) {
              console.error('Service Worker registration failed:', error);
            });
        } catch (e) {
          console.error('Error creating service worker:', e);
        }
      });
    } else {
      console.warn('Service workers not supported');
    }
  </script>
  
  <!-- Inline Manifest -->
  <script>
    // Generate manifest.json programmatically
    window.addEventListener('load', function() {
      try {
        const manifestData = {
          "name": "Cryptocurrency Price Tracker",
          "short_name": "Crypto Tracker",
          "description": "Track cryptocurrency prices in real-time",
          "start_url": "./",
          "display": "standalone",
          "background_color": "#ecf0f1",
          "theme_color": "#3498db",
          "icons": [
            {
              "src": "./icons/icon-512x512.svg",
              "sizes": "512x512",
              "type": "image/svg+xml",
              "purpose": "any"
            }
          ]
        };
        
        const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
          manifestLink.href = manifestURL;
        }
      } catch (e) {
        console.error('Error creating manifest:', e);
      }
    });
  </script>
</head>
<body>
  <div class="offline-banner" id="offline-banner">
    You are currently offline. Some features may be limited.
  </div>

  <div class="container">
    <h1>Crypto Tracker</h1>
    
    <div id="install-prompt" class="install-prompt">
      <p>Install this app on your device for better experience</p>
      <button id="install-btn" class="install-btn">Install</button>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="all">All Cryptocurrencies</div>
      <div class="tab" data-tab="favorites">Favorites</div>
    </div>
    
    <div id="error-container"></div>
    
    <div class="search-container">
      <div class="search-input-wrapper">
        <input type="text" id="crypto-search" placeholder="Search for cryptocurrency..." autocomplete="off" />
      </div>
      <button id="add-btn">Add Cryptocurrency</button>
    </div>
    
    <div id="tab-all" class="tab-content">
      <div id="crypto-container" class="crypto-container"></div>
      <div id="loader" class="loader">
        <div class="spinner"></div>
      </div>
    </div>
    
    <div id="tab-favorites" class="tab-content" style="display: none;">
      <div class="favorites-title">
        <h2>Your Favorites</h2>
        <span class="star">★</span>
      </div>
      <div id="favorites-container" class="crypto-container"></div>
    </div>
    
    <footer>
      <p>© 2025 Crypto Tracker - Data provided by Coinbase API</p>
    </footer>
  </div>

  <!-- Icon Templates (SVG) -->
  <template id="app-icons">
    <!-- App Icon SVG -->
    <svg id="app-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <circle cx="256" cy="256" r="256" fill="#3498db"/>
      <path d="M256 112c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 240c-52.8 0-96-43.2-96-96s43.2-96 96-96 96 43.2 96 96-43.2 96-96 96z" fill="white"/>
      <path d="M256 192c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 96c-17.6 0-32-14.4-32-32s14.4-32 32-32 32 14.4 32 32-14.4 32-32 32z" fill="white"/>
      <path d="M288 144h-64v-48h64v48zm-32 224h-32v48h32v-48zm96-160h48v32h-48v-32zm-224 32h-48v-32h48v32z" fill="white"/>
    </svg>
    
    <!-- Star Icon SVG (for favorites) -->
    <svg id="star-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"/>
    </svg>
    
    <!-- Placeholder Icon SVG (for crypto without specific icon) -->
    <svg id="placeholder-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#f1f1f1"/>
      <path d="M12 6v12M6 12h12" stroke="#888" stroke-width="2"/>
    </svg>
  </template>

  <!-- Core Application Scripts -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/state.js"></script>
  <script src="js/storage-service.js"></script>
  <script src="js/api-service.js"></script>
  <script src="js/chart-service.js"></script>
  <script src="js/ui-service.js"></script>
  <script src="js/crypto-manager.js"></script>
  <script src="js/pwa-manager.js"></script>
  <script src="js/app.js"></script>
</body>
</html>